<!DOCTYPE html>
<html lang="es">
<head>
<!-- Hotjar Tracking Code for mi sitio web -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:6486284,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>
  <meta charset="UTF-8" />
  <title>Nueva Publicación - Charity</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <script>
    // Asegura alto contraste aplicando tema oscuro si el fondo es negro
    (function(){
      try {
        var t = localStorage.getItem('theme');
        if (!t || t === 'dark') {
          document.documentElement.setAttribute('data-theme','dark');
        }
      } catch(e) {
        document.documentElement.setAttribute('data-theme','dark');
      }
    })();
  </script>
  <style>
    body {
      background: #000;
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      padding: 0;
    }
    header {
      background: var(--primary);
      color: #fff;
      padding: 16px 10px 12px 10px;
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      border-radius: 0 0 12px 12px;
      margin-bottom: 0;
    }
    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100vw;
      min-height: 80vh;
      background: #181828;
      padding: 0;
      margin: 0;
    }
    .publicacion-card {
      background: #23233a;
      border-radius: 18px;
      box-shadow: 0 4px 24px #2d0267;
      padding: 32px 24px;
      max-width: 420px;
      width: 100%;
      margin: 32px auto;
    }
    .publicacion-card h2 {
      text-align: center;
      color: #a78bfa;
      margin-bottom: 18px;
      font-size: 2rem;
      font-weight: 700;
    }
    .form-group {
      margin-bottom: 14px;
      text-align: left;
      width: 100%;
      max-width: 100%;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      color: #bda6e6;
      font-weight: 500;
      font-size: 1.1rem;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1.5px solid #3b2a6d;
      border-radius: 8px;
      font-size: 1.08rem;
      background: #181828;
      color: #ede9fe;
      margin-bottom: 2px;
      transition: border 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }
    .form-group textarea {
      min-height: 80px;
      font-family: inherit;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #6d28d9;
      box-shadow: 0 0 0 2px #6d28d9;
    }
    .btn-auth, .btn-publicar {
      width: 100%;
      max-width: 400px;
      padding: 18px 0;
      background: #a78bfa;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.18rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      margin: 18px auto 0 auto;
      display: block;
    }
    .btn-auth:active, .btn-publicar:active,
    .btn-auth:hover, .btn-publicar:hover {
      background: #6d28d9;
      color: #fff;
    }
    .btn-gestionar {
      width: 100%;
      max-width: 400px;
      margin-top: 16px;
      background: #22223b;
      color: #ede9fe;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      padding: 12px 0;
      display: block;
    }
    .btn-gestionar:hover {
      background: #6d28d9;
      color: #fff;
    }
    .publicacion-lista {
      padding: 0 10px;
    }
    @media (max-width: 600px) {
      .form-container {
        min-width: unset;
        max-width: 98vw;
        padding: 18px 4vw 18px 4vw;
      }
    }
    /* Navegación inferior estilo Android */
    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      min-width: 100vw;
      max-width: 100vw;
      background: #181028;
      border-top: 2px solid #6d28d9;
      display: flex;
      flex-direction: row;
      justify-content: stretch;
      align-items: stretch;
      padding: 0;
      z-index: 100;
      height: 70px;
      box-shadow: 0 -2px 18px #2d0267;
      margin: 0;
      border-radius: 0;
    }
    .bottom-nav button {
      flex: 1 1 0;
      background: none;
      color: #a78bfa;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      height: 100%;
      width: 100%;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      border-radius: 0;
      margin: 0;
      padding: 8px 4px;
      outline: none;
      min-width: 0;
    }
    .bottom-nav button i {
      font-size: 1.4rem;
      margin-bottom: 2px;
    }
    .bottom-nav button:active, .bottom-nav button:focus {
      background: #2d0267;
      color: #fff;
      outline: none;
    }
    .bottom-nav button:hover {
      color: #fff;
      background: #2d0267;
    }
    .bottom-nav button.selected {
      color: #fff;
      background: #2d0267;
    }
    .preview-img {
      display: none;
      max-width: 180px;
      max-height: 180px;
      border-radius: 12px;
      margin: 12px auto 8px auto;
      box-shadow: 0 2px 8px #2d0267;
      background: #222;
    }
    .input-error {
      border-color: #ff6b6b !important;
      box-shadow: 0 0 0 2px #ff6b6b44 !important;
    }
    .input-success {
      border-color: #22c55e !important;
      box-shadow: 0 0 0 2px #22c55e44 !important;
    }
    .msg-feedback {
      margin: 10px 0 0 0;
      font-size: 1rem;
      text-align: center;
      border-radius: 8px;
      padding: 8px 0;
      display: none;
    }
    .msg-success {
      background: #22c55e22;
      color: #22c55e;
    }
    .msg-error {
      background: #ff6b6b22;
      color: #ff6b6b;
    }
    .tip {
      color: #bda6e6;
      font-size: 0.98rem;
      margin-bottom: 8px;
      text-align: left;
      width: 100%;
    }
    .btn-limpiar {
      background: #22223b;
      color: #ede9fe;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      padding: 12px 0;
      margin-top: 10px;
      width: 100%;
      max-width: 400px;
      display: block;
    }
    .btn-limpiar:hover {
      background: #6d28d9;
      color: #fff;
    }
  </style>
</head>
<body>
  <!-- Header con reloj -->
  <header>
    <span class="time" id="hora-actual">00:00</span>
    <h1 style="color: white; margin: 0; font-size: 1.2rem;">Nueva Publicación</h1>
  </header>

  <!-- Formulario principal para crear publicación -->
  <main style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; width: 100vw; min-height: 80vh; background: #181828; padding: 0; margin: 0;">
    <div class="publicacion-card" style="background:#23233a;border-radius:18px;box-shadow:0 4px 24px #2d0267;padding:32px 24px;max-width:420px;width:100%;margin:32px auto;">
      <h2 style="text-align:center;color:#a78bfa;margin-bottom:18px;font-size:2rem;font-weight:700;">Crear Nueva Publicación</h2>
      <form id="publicacion-form">
        <div class="form-group" style="margin-bottom:14px;">
          <label for="nombreCompleto" style="color:#bda6e6;font-weight:500;font-size:1.1rem;">Nombre Completo *</label>
          <input type="text" id="nombreCompleto" name="nombreCompleto" required placeholder="Ej. Juan Pérez" style="width:100%;padding:14px 16px;border-radius:8px;font-size:1.08rem;background:#181828;color:#ede9fe;border:1.5px solid #3b2a6d;margin-bottom:2px;" />
          <div class="tip" style="color:#bda6e6;font-size:0.98rem;margin-bottom:8px;">Tu nombre real ayuda a generar confianza.</div>
        </div>
        <div class="form-group" style="margin-bottom:14px;">
          <label for="oficio" style="color:#bda6e6;font-weight:500;font-size:1.1rem;">Oficio</label>
          <select id="oficio" name="oficio" style="width:100%;padding:14px 16px;border-radius:8px;font-size:1.08rem;background:#181828;color:#ede9fe;border:1.5px solid #3b2a6d;margin-bottom:2px;">
            <option value="">Selecciona un oficio</option>
            <option value="plomero">Plomero</option>
            <option value="electricista">Electricista</option>
            <option value="pintor">Pintor</option>
            <option value="jardinero">Jardinero</option>
            <option value="albañil">Albañil</option>
            <option value="carpintero">Carpintero</option>
            <option value="mecanico">Mecánico</option>
            <option value="limpieza">Limpieza</option>
            <option value="otros">Otros</option>
          </select>
          <div class="tip" style="color:#bda6e6;font-size:0.98rem;margin-bottom:8px;">Selecciona el oficio principal que ofreces.</div>
        </div>
        <div class="form-group" style="margin-bottom:14px;">
          <label for="descripcion" style="color:#bda6e6;font-weight:500;font-size:1.1rem;">Descripción del Trabajo *</label>
          <textarea id="descripcion" name="descripcion" required placeholder="Describe los servicios que ofreces, tu experiencia, horarios disponibles, etc." style="width:100%;padding:14px 16px;border-radius:8px;font-size:1.08rem;background:#181828;color:#ede9fe;border:1.5px solid #3b2a6d;margin-bottom:2px;min-height:80px;"></textarea>
          <div class="tip" style="color:#bda6e6;font-size:0.98rem;margin-bottom:8px;">Ejemplo: "Más de 5 años de experiencia. Trabajo rápido y garantizado."</div>
        </div>
        <div class="form-group" style="margin-bottom:14px;">
          <label for="lugar" style="color:#bda6e6;font-weight:500;font-size:1.1rem;">Lugar de Trabajo *</label>
          <input type="text" id="lugar" name="lugar" required placeholder="Ciudad, colonia o zona donde trabajas" style="width:100%;padding:14px 16px;border-radius:8px;font-size:1.08rem;background:#181828;color:#ede9fe;border:1.5px solid #3b2a6d;margin-bottom:2px;" />
          <div class="tip" style="color:#bda6e6;font-size:0.98rem;margin-bottom:8px;">Ejemplo: "Tula de Allende, Hidalgo"</div>
        </div>
        <div class="form-group" style="margin-bottom:14px;">
          <label for="imagen" style="color:#bda6e6;font-weight:500;font-size:1.1rem;">Imagen (opcional)</label>
          <input type="file" id="imagen" name="imagen" accept="image/*" style="width:100%;padding:8px 0;border-radius:8px;font-size:1.08rem;background:#181828;color:#ede9fe;border:1.5px solid #3b2a6d;margin-bottom:2px;" />
          <img id="preview-img" class="preview-img" alt="Vista previa" style="display:none;max-width:180px;max-height:180px;border-radius:12px;margin:12px auto 8px auto;box-shadow:0 2px 8px #2d0267;background:#222;" />
          <div class="tip" style="color:#bda6e6;font-size:0.98rem;margin-bottom:8px;">Agrega una foto de tu trabajo o tuya para destacar tu publicación.</div>
        </div>
        <div class="msg-feedback msg-success" id="publicacion-success"></div>
        <div class="msg-feedback msg-error" id="publicacion-error"></div>
        <button type="submit" class="btn-publicar" style="width:100%;max-width:400px;padding:18px 0;background:#a78bfa;color:#fff;border:none;border-radius:8px;font-size:1.18rem;font-weight:700;cursor:pointer;margin:18px auto 0 auto;display:block;">Crear Publicación</button>
      </form>
      <button class="btn-gestionar" onclick="toggleGestionPublicaciones()" style="width:100%;max-width:400px;margin-top:16px;background:#22223b;color:#ede9fe;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:background 0.2s, color 0.2s;padding:12px 0;display:block;">📋 Gestionar Publicaciones</button>
    </div>
    <div class="gestion-panel" id="gestion-panel" style="display:none;">
      <div class="gestion-content" style="background:#23233a;border-radius:18px;box-shadow:0 4px 24px #2d0267;padding:24px 18px;max-width:420px;width:100%;margin:24px auto;">
        <h3 style="color:#a78bfa;text-align:center;">Mis Publicaciones</h3>
        <div class="publicaciones-lista" id="publicaciones-lista"></div>
      </div>
    </div>
  </main>

  <!-- Navegación inferior estilo Android -->
  <nav class="bottom-nav">
    <button onclick="location.href='home.html'">
      <i class="fa fa-home"></i>
      <span>Inicio</span>
    </button>
    <button onclick="location.href='mensajes.html'">
      <i class="fa fa-envelope"></i>
      <span>Mensajes</span>
    </button>
    <button onclick="location.href='nueva-publicacion.html'" class="selected">
      <i class="fa fa-plus-square"></i>
      <span>Publicación</span>
    </button>
    <button onclick="location.href='perfil.html'">
      <i class="fa fa-user"></i>
      <span>Perfil</span>
    </button>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC_IPUuZcUKPNPR7gJWkg1SpD7UcvFMu3s",
      authDomain: "charity-6d1de.firebaseapp.com",
      projectId: "charity-6d1de",
      storageBucket: "charity-6d1de.appspot.com",
      messagingSenderId: "302361818428",
      appId: "1:302361818428:web:f2b3d33a86497a117c1a39",
      measurementId: "G-YPYBFPP29H"
    };
    firebase.initializeApp(firebaseConfig);
    // Ya puedes usar firebase.firestore()
  </script>
  <script>
    firebase.firestore().collection("prueba_conexion").get()
      .then((querySnapshot) => {
        console.log("¡Firestore conectado! Documentos encontrados:", querySnapshot.size);
      })
      .catch((error) => {
        console.error("Error al conectar con Firestore:", error);
      });
  </script>
  <script src="script.js"></script>
  <script>
    /*
     * FUNCIONALIDAD DE NUEVA PUBLICACIÓN
     * 
     * Este script maneja la creación de publicaciones y la gestión
     * de publicaciones existentes del usuario.
     */

    /**
     * Crea una nueva publicación y la guarda en localStorage
     * @param {Event} event - Evento del formulario
     */
    // Elimina la función crearPublicacion y el uso de localStorage para publicaciones

    /**
     * Muestra u oculta el panel de gestión de publicaciones
     */
    function toggleGestionPublicaciones() {
      const panel = document.getElementById('gestion-panel');
      const btnGestionar = document.querySelector('.btn-gestionar');
      
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btnGestionar.textContent = '❌ Cerrar Gestión';
        btnGestionar.style.background = '#dc3545';
        cargarPublicacionesUsuario();
      } else {
        panel.style.display = 'none';
        btnGestionar.textContent = '📋 Gestionar Publicaciones';
        btnGestionar.style.background = '#6c757d';
      }
    }

    /**
     * Carga y muestra las publicaciones del usuario en el panel de gestión
     */
    function cargarPublicacionesUsuario() {
  const listaContainer = document.getElementById('publicaciones-lista');
  listaContainer.innerHTML = '<div style="color:#bda6e6;text-align:center;">Cargando publicaciones...</div>';

  firebase.firestore().collection('publicaciones')
    .orderBy('fecha', 'desc')
    .get()
    .then((querySnapshot) => {
      if (querySnapshot.empty) {
        listaContainer.innerHTML = '<div class="sin-publicaciones">No tienes publicaciones aún</div>';
        return;
      }
      listaContainer.innerHTML = '';
      querySnapshot.forEach((doc) => {
        const publicacion = doc.data();
        const fecha = publicacion.fecha && publicacion.fecha.toDate
          ? publicacion.fecha.toDate().toLocaleString()
          : '';
        const itemDiv = document.createElement('div');
        itemDiv.className = 'publicacion-item';
        itemDiv.innerHTML = `
          <h4>${publicacion.nombreCompleto}</h4>
          <p><strong>Oficio:</strong> ${publicacion.oficio}</p>
          <p><strong>Lugar:</strong> ${publicacion.lugar}</p>
          <p class="fecha">${fecha}</p>
          <button class="btn-eliminar" onclick="eliminarPublicacionFirestore('${doc.id}')">🗑️ Eliminar</button>
          <div style="clear: both;"></div>
        `;
        listaContainer.appendChild(itemDiv);
      });
    })
    .catch((error) => {
      listaContainer.innerHTML = '<div class="sin-publicaciones">Error al cargar publicaciones</div>';
      console.error("Error al cargar publicaciones:", error);
    });
}

// Nueva función para eliminar publicaciones en Firestore
function eliminarPublicacionFirestore(id) {
  if (confirm('¿Estás seguro de que quieres eliminar esta publicación?')) {
    firebase.firestore().collection('publicaciones').doc(id).delete()
      .then(() => {
        mostrarMensaje('Publicación eliminada exitosamente', 'success');
        cargarPublicacionesUsuario();
      })
      .catch((error) => {
        mostrarMensaje('Error al eliminar la publicación', 'error');
        console.error("Error al eliminar publicación:", error);
      });
  }
}
    /**
     * Elimina una publicación específica
     * @param {number} index - Índice de la publicación a eliminar
     */
    function eliminarPublicacion(index) {
      if (confirm('¿Estás seguro de que quieres eliminar esta publicación?')) {
        let publicaciones = JSON.parse(localStorage.getItem('publicaciones') || '[]');
        
        if (index >= 0 && index < publicaciones.length) {
          publicaciones.splice(index, 1);
          
          if (guardarEnStorage('publicaciones', publicaciones)) {
            mostrarMensaje('Publicación eliminada exitosamente', 'success');
            cargarPublicacionesUsuario();
          }
        }
      }
    }

    // Inicialización cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
      // Configurar validación en tiempo real
      const camposRequeridos = document.querySelectorAll('[required]');
      camposRequeridos.forEach(campo => {
        campo.addEventListener('blur', function() {
          if (campoVacio(this.value)) {
            this.style.borderColor = '#dc3545';
          } else {
            this.style.borderColor = '';
          }
        });
      });

      // Vista previa de imagen
      const imagenInput = document.getElementById('imagen');
      const previewImg = document.getElementById('preview-img');
      if (imagenInput && previewImg) {
        imagenInput.addEventListener('change', function() {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
              previewImg.src = e.target.result;
              previewImg.style.display = 'block';
            };
            reader.readAsDataURL(this.files[0]);
          } else {
            previewImg.src = '';
            previewImg.style.display = 'none';
          }
        });
      }
      // Validación visual en tiempo real
      function setInputState(input, state) {
        input.classList.remove('input-error', 'input-success');
        if (state === 'error') input.classList.add('input-error');
        if (state === 'success') input.classList.add('input-success');
      }
      const nombreCompletoEl = document.getElementById('nombreCompleto');
      const descripcionEl = document.getElementById('descripcion');
      const lugarEl = document.getElementById('lugar');
      ['nombreCompleto','descripcion','lugar'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('blur', function() {
            if (!this.value.trim()) {
              setInputState(this, 'error');
            } else {
              setInputState(this, 'success');
            }
          });
        }
      });
      // Limpiar formulario
      function limpiarFormulario() {
        const form = document.getElementById('publicacion-form');
        if (form) form.reset();
        if (previewImg) {
          previewImg.src = '';
          previewImg.style.display = 'none';
        }
        document.querySelectorAll('.input-error, .input-success').forEach(el => el.classList.remove('input-error','input-success'));
        const publicacionSuccess = document.getElementById('publicacion-success');
        if (publicacionSuccess) publicacionSuccess.style.display = 'none';
        const publicacionError = document.getElementById('publicacion-error');
        if (publicacionError) publicacionError.style.display = 'none';
      }

      const form = document.getElementById('publicacion-form');
      if (form) {
        form.addEventListener('submit', async function(event) {
          event.preventDefault();
          console.log('Intentando guardar en Firestore...'); // <-- Esto debe aparecer en consola
          const nombreCompleto = document.getElementById('nombreCompleto').value.trim();
          const oficio = document.getElementById('oficio').value;
          const descripcion = document.getElementById('descripcion').value.trim();
          const lugar = document.getElementById('lugar').value.trim();
          const autorCorreo = localStorage.getItem('usuarioActual') || 'anónimo';
          if (!nombreCompleto || !descripcion || !lugar) {
            alert('Por favor completa todos los campos requeridos');
            return;
          }
          await firebase.firestore().collection('publicaciones').add({
            nombreCompleto,
            oficio: oficio || 'No especificado',
            descripcion,
            lugar,
            autorCorreo,
            fecha: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert('¡Publicación creada exitosamente!');
          form.reset();
        });
      }
    });
  </script>
</body>
</html>